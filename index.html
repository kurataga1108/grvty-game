<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GitHub GRVTY - The Last Fix</title>
    <style>
        :root { --bg: #ffffff; --wall: #216e39; --ball: #24292f; --goal: #39d353; --spike: #cf222e; }
        body { margin: 0; background: var(--bg); overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; font-family: -apple-system, sans-serif; }
        #menu, #clear-screen { position: absolute; width: 100%; height: 100%; background: rgba(255,255,255,0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        .hidden { display: none !important; }
        canvas { background: #f6f8fa; border: 1px solid #d0d7de; border-radius: 6px; touch-action: none; }
        select, button { padding: 10px 20px; font-size: 1rem; border-radius: 6px; border: 1px solid #d0d7de; margin: 8px; cursor: pointer; background: #24292f; color: white; }
        #ui-bar { width: 85%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        #reset-btn { background: #fff; color: #cf222e; font-weight: bold; }
    </style>
</head>
<body>

    <div id="menu">
        <h1 style="color:#216e39">GitHub GRVTY</h1>
        <p>今度こそクリアできるステージを厳選</p>
        <select id="stage-select">
            <option value="0">STAGE 1: Training</option>
            <option value="1">STAGE 2: Bug Avoidance</option>
            <option value="2">STAGE 3: The Path to Goal</option>
        </select>
        <button onclick="startGame()">START GAME</button>
    </div>

    <div id="clear-screen" class="hidden">
        <h1 style="color:var(--wall)">STAGE CLEAR!</h1>
        <button onclick="nextLevel()">NEXT STAGE</button>
        <button onclick="location.reload()">MENU</button>
    </div>

    <div id="ui-bar">
        <div id="status" style="font-weight:bold">STAGE 1</div>
        <button id="reset-btn" onclick="resetBall()">RESET</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const screenSize = Math.min(window.innerWidth, window.innerHeight) * 0.85;
        canvas.width = screenSize; canvas.height = screenSize;
        const grid = 10; const tileSize = screenSize / grid;

        let currentStage = 0; let gravity = {x:0, y:0}; let isMoving = false;
        let ball = {x:0, y:0, vx:0, vy:0, radius: tileSize * 0.25};
        let particles = [];

        // 0:道, 1:壁, 2:ゴール, 3:トゲ(Bug)
        const levels = [
            // Stage 1: 右→下→左
            [
                [1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,1],[1,0,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,0,1],[1,0,0,0,0,0,0,0,0,1],[1,0,1,1,1,1,1,1,1,1],[1,2,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1]
            ],
            // Stage 2: トゲを避ける
            [
                [1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,3,0,0,0,1],[1,1,1,1,0,1,1,1,0,1],[1,0,0,0,0,0,0,1,0,1],[1,0,1,1,1,1,0,1,0,1],[1,0,1,2,0,0,0,0,0,1],[1,0,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1]
            ],
            // Stage 3: 正しい「道」のあるステージ（画像のような閉鎖を排除）
            [
                [1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,1],[1,0,1,1,1,1,1,1,0,1],[1,0,1,0,0,0,0,1,0,1],[1,0,1,0,1,1,2,1,0,1],[1,0,1,0,1,1,0,1,0,1],[1,0,1,0,0,3,0,1,0,1],[1,0,1,1,1,1,1,1,0,1],[1,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1]
            ]
        ];

        function startGame() {
            currentStage = parseInt(document.getElementById('stage-select').value);
            document.getElementById('menu').classList.add('hidden');
            initStage();
        }

        function initStage() {
            document.getElementById('status').innerText = `STAGE ${currentStage + 1}`;
            // スタート位置を固定(左上)
            ball.x = tileSize * 1.5; ball.y = tileSize * 1.5;
            ball.vx = 0; ball.vy = 0; gravity = {x:0, y:0}; isMoving = false;
            particles = [];
        }

        function resetBall() { initStage(); }

        function nextLevel() {
            document.getElementById('clear-screen').classList.add('hidden');
            currentStage = (currentStage + 1) % levels.length;
            initStage();
        }

        function update() {
            if (isMoving) {
                ball.vx += gravity.x; ball.vy += gravity.y;
                ball.x += ball.vx; ball.y += ball.vy;
            }
            
            let gx = Math.floor(ball.x / tileSize), gy = Math.floor(ball.y / tileSize);
            if (gy >= 0 && gy < grid && gx >= 0 && gx < grid) {
                const tile = levels[currentStage][gy][gx];
                if (tile === 1) { // 壁
                    ball.x -= ball.vx; ball.y -= ball.vy;
                    ball.vx = 0; ball.vy = 0; gravity = {x:0, y:0}; isMoving = false;
                } else if (tile === 2) { // ゴール
                    isMoving = false; 
                    if (particles.length === 0) {
                        createFireworks();
                        setTimeout(() => document.getElementById('clear-screen').classList.remove('hidden'), 800);
                    }
                } else if (tile === 3) { // トゲ（バグ）
                    resetBall();
                }
            }
            updateParticles();
            draw();
            requestAnimationFrame(update);
        }

        function createFireworks() {
            for(let i=0; i<40; i++) {
                particles.push({x:ball.x, y:ball.y, vx:(Math.random()-0.5)*12, vy:(Math.random()-0.5)*12, life:1, c:`hsl(${Math.random()*360},70%,50%)`});
            }
        }
        function updateParticles() {
            particles.forEach((p,i) => { p.x += p.vx; p.y += p.vy; p.life -= 0.02; if(p.life<=0) particles.splice(i,1); });
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const map = levels[currentStage];
            for (let y = 0; y < grid; y++) {
                for (let x = 0; x < grid; x++) {
                    let tx = x*tileSize, ty = y*tileSize;
                    if (map[y][x] === 1) { ctx.fillStyle = "#216e39"; ctx.fillRect(tx+1, ty+1, tileSize-2, tileSize-2); }
                    else if (map[y][x] === 2) { ctx.fillStyle = "#39d353"; ctx.fillRect(tx+1, ty+1, tileSize-2, tileSize-2); }
                    else if (map[y][x] === 3) { ctx.fillStyle = "#cf222e"; ctx.beginPath(); ctx.arc(tx+tileSize/2, ty+tileSize/2, tileSize/4, 0, Math.PI*2); ctx.fill(); }
                }
            }
            particles.forEach(p => { ctx.globalAlpha = p.life; ctx.fillStyle = p.c; ctx.fillRect(p.x, p.y, 4, 4); });
            ctx.globalAlpha = 1; ctx.fillStyle = "#24292f"; ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI*2); ctx.fill();
        }

        let tsX, tsY;
        window.addEventListener('touchstart', e => { tsX = e.touches[0].clientX; tsY = e.touches[0].clientY; }, { passive: false });
        window.addEventListener('touchend', e => {
            if (isMoving || !document.getElementById('clear-screen').classList.contains('hidden')) return;
            let dx = e.changedTouches[0].clientX - tsX, dy = e.changedTouches[0].clientY - tsY;
            if (Math.abs(dx) < 20 && Math.abs(dy) < 20) return;
            isMoving = true;
            if (Math.abs(dx) > Math.abs(dy)) gravity = {x: dx > 0 ? 0.9 : -0.9, y: 0};
            else gravity = {x: 0, y: dy > 0 ? 0.9 : -0.9};
        }, { passive: false });

        update();
    </script>
</body>
</html>
